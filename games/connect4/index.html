<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4 Gewinnt - LogicCastle</title>
    <link rel="stylesheet" href="../../assets/css/main.css" />
    <link rel="stylesheet" href="css/game.css" />
    <link rel="stylesheet" href="css/ui.css" />
    <link rel="stylesheet" href="css/ui-module-enhancements.css" />
  </head>
  <body>
    <div class="game-container">
      <header class="game-header">
        <div class="header-left">
          <a href="../../index.html" class="back-button">‚Üê Zur√ºck</a>
          <h1>üî¥ 4 Gewinnt</h1>
          <div class="game-mode-selector">
            <label for="gameMode">Spielmodus:</label>
            <select id="gameMode">
              <option value="two-player">2 Spieler</option>
              <option value="vs-bot-easy">vs Einfache KI</option>
              <option value="vs-bot-medium">vs Mittlere KI</option>
              <option value="vs-bot-hard">vs Schwere KI</option>
            </select>
          </div>
        </div>
        <div class="header-controls">
          <button class="btn btn-primary" id="newGameBtn">Neues Spiel (N)</button>
          <button class="btn btn-secondary" id="undoBtn" disabled>R√ºckg√§ngig (U)</button>
          <button class="btn btn-outline" id="resetScoreBtn">Score zur√ºcksetzen (F3)</button>
          <button class="btn btn-success" id="assistanceBtn">Spielerhilfen (F2)</button>
          <button class="btn btn-info" id="helpBtn">Spielanleitung (F1)</button>
        </div>
      </header>

      <main class="game-main">
        <div class="game-board-container">
          <div class="board-coords top grid grid-cols-7 mb-2" id="topCoords" style="gap: 8px;">
            <!-- Column numbers 1-7 will be generated with grid alignment -->
          </div>
          <div class="board-wrapper">
            <div class="game-board" id="gameBoard">
              <!-- 6x7 grid = 42 slots -->
              <!-- Generated dynamically by JavaScript -->
            </div>
          </div>
          <div class="board-coords bottom grid grid-cols-7 mt-2" id="bottomCoords" style="gap: 8px;">
            <!-- Column numbers 1-7 will be generated with grid alignment -->
          </div>
        </div>

        <div class="game-info-compact">
          <div class="info-section">
            <h3>Aktueller Spieler</h3>
            <div class="current-player">
              <span class="player-indicator" id="currentPlayerIndicator">
                <span class="player-disc yellow"></span>
                <span class="player-name">Spieler 1</span>
              </span>
            </div>
          </div>

          <div class="info-section">
            <h3>Spielstand</h3>
            <div class="score-compact">
              <div class="score yellow">
                <span class="score-label">Gelb:</span>
                <span class="score-value" id="yellowScore">0</span>
              </div>
              <div class="score red">
                <span class="score-label">Rot:</span>
                <span class="score-value" id="redScore">0</span>
              </div>
            </div>
          </div>

          <div class="info-section">
            <h3>Spiel-Info</h3>
            <div class="game-status" id="gameStatus">Spiel l√§uft...</div>
            <div class="move-info">
              <span class="move-label">Z√ºge:</span>
              <span class="move-value" id="moveCounter">0</span>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- Player Assistance Modal -->
    <div class="modal-overlay hidden" id="assistanceModal">
      <div class="modal assistance-modal">
        <h2>üéõÔ∏è Spielerhilfen</h2>

        <div class="help-content">
          <table class="assistance-table">
            <thead>
              <tr>
                <th class="assistance-feature-col">Spielerhilfe</th>
                <th class="assistance-player-col player1-col">üü° Spieler 1 (Gelb)</th>
                <th class="assistance-player-col player2-col">üî¥ Spieler 2 (Rot)</th>
              </tr>
            </thead>
            <tbody>
              <tr class="assistance-row">
                <td class="assistance-feature">
                  <div class="feature-info">
                    <span class="feature-icon">üîÑ</span>
                    <div class="feature-details">
                      <span class="feature-name">Zug r√ºckg√§ngig machen</span>
                      <span class="feature-description">Spieler kann eigene Z√ºge r√ºckg√§ngig machen</span>
                    </div>
                  </div>
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player1-undo" class="assistance-checkbox">
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player2-undo" class="assistance-checkbox">
                </td>
              </tr>
              
              <tr class="assistance-row">
                <td class="assistance-feature">
                  <div class="feature-info">
                    <span class="feature-icon">‚ö†Ô∏è</span>
                    <div class="feature-details">
                      <span class="feature-name">Bedrohungen anzeigen</span>
                      <span class="feature-description">Zeigt gegnerische Gewinnbedrohungen an</span>
                    </div>
                  </div>
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player1-threats" class="assistance-checkbox">
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player2-threats" class="assistance-checkbox">
                </td>
              </tr>
              
              <tr class="assistance-row">
                <td class="assistance-feature">
                  <div class="feature-info">
                    <span class="feature-icon">üèÜ</span>
                    <div class="feature-details">
                      <span class="feature-name">Gewinnz√ºge hervorheben</span>
                      <span class="feature-description">Markiert direkte Gewinnm√∂glichkeiten</span>
                    </div>
                  </div>
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player1-winning-moves" class="assistance-checkbox">
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player2-winning-moves" class="assistance-checkbox">
                </td>
              </tr>
              
              <tr class="assistance-row">
                <td class="assistance-feature">
                  <div class="feature-info">
                    <span class="feature-icon">üö´</span>
                    <div class="feature-details">
                      <span class="feature-name">Gesperrte Spalten anzeigen</span>
                      <span class="feature-description">Zeigt strategisch ung√ºnstige Spalten an</span>
                    </div>
                  </div>
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player1-blocked-columns" class="assistance-checkbox">
                </td>
                <td class="assistance-checkbox-cell">
                  <input type="checkbox" id="player2-blocked-columns" class="assistance-checkbox">
                </td>
              </tr>
            </tbody>
          </table>

          <div class="help-section">
            <h3>‚ÑπÔ∏è Hinweise</h3>
            <ul>
              <li>Spielerhilfen k√∂nnen jederzeit aktiviert/deaktiviert werden</li>
              <li>Jeder Spieler kann individuelle Hilfen verwenden</li>
              <li>Hilfen beeinflussen nur die Anzeige, nicht die Spiellogik</li>
              <li>In KI-Modi gelten Hilfen nur f√ºr menschliche Spieler</li>
            </ul>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-primary" id="closeAssistanceBtn">Einstellungen speichern</button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay hidden" id="helpModal">
      <div class="modal help-modal">
        <h2>üî¥ 4 Gewinnt - Spielanleitung</h2>

        <div class="help-content">
          <div class="help-section">
            <h3>üéØ Spielziel</h3>
            <p>
              Verbinde vier deiner Spielsteine in einer geraden Linie (horizontal, vertikal oder diagonal) 
              auf dem 7x6 Spielfeld!
            </p>
          </div>

          <div class="help-section">
            <h3>üéÆ Spielablauf</h3>
            <ul>
              <li>Gelb beginnt und wirft den ersten Spielstein ein</li>
              <li>Spieler werfen abwechselnd ihre Steine in eine der 7 Spalten</li>
              <li>Steine fallen durch die Schwerkraft nach unten</li>
              <li>Der erste Spieler mit 4 Steinen in einer Reihe gewinnt</li>
              <li>Bei vollem Brett ohne Gewinner gibt es ein Unentschieden</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üéÆ Steuerung</h3>
            <div class="control-group">
              <h4>üñ±Ô∏è Maus/Touch:</h4>
              <ul>
                <li><strong>Klick:</strong> Stein in Spalte einwerfen</li>
                <li><strong>Hover:</strong> Vorschau des Zuges anzeigen</li>
              </ul>
            </div>

            <div class="control-group">
              <h4>‚å®Ô∏è Tastatur:</h4>
              <ul>
                <li><strong>1-7:</strong> Stein in Spalte 1-7 einwerfen</li>
                <li><strong>N:</strong> Neues Spiel</li>
                <li><strong>U:</strong> Zug r√ºckg√§ngig</li>
                <li><strong>F1:</strong> Spielanleitung √∂ffnen/schlie√üen</li>
                <li><strong>F2:</strong> Spielerhilfen √∂ffnen/schlie√üen</li>
                <li><strong>F3:</strong> Score zur√ºcksetzen</li>
              </ul>
            </div>
          </div>

          <div class="help-section">
            <h3>ü§ñ Spielmodi</h3>
            <ul>
              <li><strong>2 Spieler:</strong> Spiele gegen einen Freund</li>
              <li><strong>vs Einfache KI:</strong> Perfekt f√ºr Anf√§nger</li>
              <li><strong>vs Mittlere KI:</strong> Ausbalancierte Herausforderung</li>
              <li><strong>vs Schwere KI:</strong> Maximale Herausforderung mit Minimax-Algorithmus</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üéõÔ∏è Spielerhilfen</h3>
            <ul>
              <li><strong>Gewinnz√ºge:</strong> Gr√ºn leuchtende Spalten f√ºhren zum sofortigen Sieg</li>
              <li><strong>Bedrohungen:</strong> Orange markierte Spalten blockieren gegnerische Gewinne</li>
              <li><strong>Gesperrte Spalten:</strong> Rot markierte Spalten sollten vermieden werden</li>
              <li><strong>R√ºckg√§ngig:</strong> Erlaubt das Zur√ºcknehmen von Z√ºgen</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üìã Regeln</h3>
            <ul>
              <li>Steine k√∂nnen nur von oben eingeworfen werden</li>
              <li>Jede Spalte kann maximal 6 Steine aufnehmen</li>
              <li>Nur gerade Linien z√§hlen (keine Kurven oder Ecken)</li>
              <li>4 oder mehr Steine in einer Reihe bedeuten Sieg</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üí° Strategietipps</h3>
            <ul>
              <li>Beginne in der Mitte f√ºr die meisten M√∂glichkeiten</li>
              <li>Versuche gleichzeitig anzugreifen und zu verteidigen</li>
              <li>Erstelle "Gabeln" - mehrere Gewinnchancen gleichzeitig</li>
              <li>Blockiere gegnerische Bedrohungen fr√ºhzeitig</li>
              <li>Plane deine Z√ºge mehrere Runden im Voraus</li>
              <li>Kontrolliere die unteren Reihen f√ºr stabilere Positionen</li>
            </ul>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-primary" id="closeHelpBtn">Verstanden!</button>
        </div>
      </div>
    </div>

    <script type="module">
      // UI-Module System Connect4 initialization
      import { Connect4Game } from './js/game_v2.js?v=production';
      import { Connect4AI } from './js/ai_v2.js?v=production';
      import { Connect4UINew } from './js/ui-new.js?v=production';
      
      // Initialize game when DOM is loaded
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          // Check if required DOM elements exist
          const gameBoard = document.getElementById('gameBoard');
          if (!gameBoard) {
            throw new Error('Game board element not found in DOM');
          }
          
          const game = new Connect4Game();
          const ui = new Connect4UINew(game);
          const ai = new Connect4AI();
          
          ui.setAI(ai);
          
          // Make instances globally available for debugging
          window.game = game;
          window.ui = ui;
          window.ai = ai;
          
          // Setup game mode handling
          const gameModeSelect = document.getElementById('gameMode');
          if (gameModeSelect) {
            gameModeSelect.addEventListener('change', () => {
              ui.setGameMode(gameModeSelect.value);
            });
          }
          
          // Initialize UI first
          await ui.init();
          
          // ROBUST TIMING: Multiple initialization attempts with exponential backoff
          let gameInitialized = false;
          let initAttempts = 0;
          const maxAttempts = 5;
          
          while (!gameInitialized && initAttempts < maxAttempts) {
            initAttempts++;
            
            try {
              gameInitialized = await game.init();
              
              if (gameInitialized) {
                // Verify game is truly ready with timeout
                const verificationStart = Date.now();
                const maxVerificationTime = 3000;
                
                while (!game.isInitialized && (Date.now() - verificationStart) < maxVerificationTime) {
                  await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (game.isInitialized) {
                  ui.showMessage('Connect4 bereit! üéØ', 'success');
                  break;
                } else {
                  gameInitialized = false;
                }
              }
              
            } catch (initError) {
              // Silent failure, will retry
            }
            
            if (!gameInitialized && initAttempts < maxAttempts) {
              const backoffDelay = Math.min(1000 * Math.pow(2, initAttempts - 1), 5000);
              await new Promise(resolve => setTimeout(resolve, backoffDelay));
            }
          }
          
          if (!gameInitialized) {
            ui.showMessage('WASM Engine konnte nicht geladen werden. Browser-Reload versuchen.', 'error');
          }
          
        } catch (error) {
          console.error('‚ùå Failed to initialize Connect4 game:', error);
          
          // Show user-friendly error
          const errorDiv = document.createElement('div');
          errorDiv.innerHTML = `
            <div style="position: fixed; top: 20px; left: 20px; right: 20px; background: #f44336; color: white; padding: 15px; border-radius: 8px; z-index: 1000; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
              <h3 style="margin: 0 0 10px 0;">‚ùå Spielfehler</h3>
              <p style="margin: 0 0 10px 0;"><strong>Fehler:</strong> ${error.message}</p>
              <p style="margin: 0; font-size: 12px; opacity: 0.9;">Bitte laden Sie die Seite neu (F5).</p>
            </div>
          `;
          document.body.appendChild(errorDiv);
        }
        
        // TEMPORARY MODAL FIX: Direct modal control until ModalManager is fixed
        function setupTemporaryModalSystem() {
          const helpBtn = document.getElementById('helpBtn');
          const assistanceBtn = document.getElementById('assistanceBtn');
          const helpModal = document.getElementById('helpModal');
          const assistanceModal = document.getElementById('assistanceModal');
          const closeHelpBtn = document.getElementById('closeHelpBtn');
          const closeAssistanceBtn = document.getElementById('closeAssistanceBtn');
          
          // Helper function to show modal
          function showModal(modal) {
            if (modal) {
              modal.classList.remove('hidden');
              modal.classList.add('active');
              document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
          }
          
          // Helper function to hide modal
          function hideModal(modal) {
            if (modal) {
              modal.classList.add('hidden');
              modal.classList.remove('active');
              document.body.style.overflow = ''; // Restore scrolling
            }
          }
          
          // Show Help Modal
          if (helpBtn && helpModal) {
            helpBtn.addEventListener('click', (e) => {
              e.preventDefault();
              showModal(helpModal);
            });
          }
          
          // Show Assistance Modal
          if (assistanceBtn && assistanceModal) {
            assistanceBtn.addEventListener('click', (e) => {
              e.preventDefault();
              showModal(assistanceModal);
            });
          }
          
          // Close Help Modal
          if (closeHelpBtn && helpModal) {
            closeHelpBtn.addEventListener('click', (e) => {
              e.preventDefault();
              hideModal(helpModal);
            });
          }
          
          // Close Assistance Modal
          if (closeAssistanceBtn && assistanceModal) {
            closeAssistanceBtn.addEventListener('click', (e) => {
              e.preventDefault();
              hideModal(assistanceModal);
            });
          }
          
          // Close modals on escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              hideModal(helpModal);
              hideModal(assistanceModal);
            }
          });
          
          // Close modals when clicking outside
          [helpModal, assistanceModal].forEach(modal => {
            if (modal) {
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  hideModal(modal);
                }
              });
            }
          });
          
          console.log('‚úÖ Temporary modal system initialized');
        }
        
        // Initialize temporary modal system
        setupTemporaryModalSystem();
      });
    </script>
  </body>
</html>