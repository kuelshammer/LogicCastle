<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4 Gewinnt - LogicCastle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern Connect4 Glassmorphism System */
        .glass {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-hover {
            transition: all 0.2s ease;
        }
        
        .glass-hover:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Connect4 specific animations */
        @keyframes dropPiece {
            0% { transform: translateY(-100px) scale(0.8); opacity: 0; }
            50% { transform: translateY(10px) scale(1.1); opacity: 0.8; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .drop-animation {
            animation: dropPiece 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes winningGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.9); }
        }
        
        .winning-disc {
            animation: winningGlow 1s ease-in-out infinite;
        }
    </style>
    <!-- Legacy CSS for gradual migration -->
    <link rel="stylesheet" href="css/game.css" />
    <link rel="stylesheet" href="css/ui.css" />
  </head>
  <body class="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900">
    <!-- Background decoration -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute top-40 left-1/2 w-80 h-80 bg-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <div class="relative z-10" data-current-player="1">
      <!-- Header -->
      <header class="p-6 text-center">
        <div class="max-w-6xl mx-auto">
          <div class="flex items-center justify-between mb-4">
            <a href="../../index.html" class="glass px-4 py-2 rounded-xl text-white hover:bg-white hover:bg-opacity-20 transition-all duration-200">
              ‚Üê Zur√ºck zu LogicCastle
            </a>
            <div class="glass px-4 py-2 rounded-xl">
              <label for="gameMode" class="text-white text-sm mr-2">Modus:</label>
              <select id="gameMode" class="bg-transparent text-white border-none focus:outline-none">
                <option value="two-player" class="text-gray-900">2 Spieler</option>
                <option value="vs-bot-easy" class="text-gray-900">vs Einfache KI</option>
                <option value="vs-bot-medium" class="text-gray-900">vs Mittlere KI</option>
                <option value="vs-bot-hard" class="text-gray-900">vs Schwere KI</option>
              </select>
            </div>
          </div>
          <h1 class="text-4xl md:text-6xl font-bold text-white mb-2">
            <span class="inline-block w-8 h-8 bg-gradient-to-br from-red-500 to-yellow-500 rounded-full mr-3 align-middle"></span>
            4 Gewinnt
          </h1>
          <p class="text-lg md:text-xl text-white opacity-90">Modular ‚Ä¢ BitPacked ‚Ä¢ KI-Enhanced</p>
        </div>
      </header>

      <!-- Main Game Container with Responsive Grid -->
      <main class="relative z-10 max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
          
          <!-- Game Board Section (3/4 width on large screens) -->
          <div class="xl:col-span-3">
            <div class="glass rounded-3xl p-8 shadow-2xl" data-current-player="1">
              <!-- Column Coordinates Top -->
              <div class="grid grid-cols-7 gap-2 mb-4 px-4" id="topCoords">
                <!-- Column numbers 1-7 will be generated by BoardRenderer -->
              </div>
              
              <!-- Game Board Container -->
              <div class="relative">
                <div class="game-board" id="gameBoard">
                  <!-- 6x7 grid = 42 slots -->
                  <!-- Generated dynamically by BoardRenderer component -->
                </div>
                <!-- Particle Engine Canvas for Victory Celebrations -->
                <canvas id="particleCanvas" 
                        class="absolute inset-0 w-full h-full pointer-events-none z-50">
                </canvas>
              </div>
              
              <!-- Column Coordinates Bottom -->
              <div class="grid grid-cols-7 gap-2 mt-4 px-4" id="bottomCoords">
                <!-- Column numbers 1-7 will be generated by BoardRenderer -->
              </div>
            </div>
          </div>
          
          <!-- Game Info Sidebar (1/4 width) -->
            <!-- Current Player Status -->
            <div class="glass rounded-2xl p-6 shadow-xl">
              <h3 class="text-xl font-bold text-white mb-4">Aktueller Spieler</h3>
              <div class="flex items-center justify-center">
                <span class="player-indicator flex items-center" id="currentPlayerIndicator">
                  <span class="player-disc w-8 h-8 rounded-full mr-3 bg-gradient-to-br from-yellow-400 to-yellow-600 shadow-lg"></span>
                  <span class="player-name text-white font-semibold">Spieler 1</span>
                </span>
              </div>
            </div>

            <!-- Score Board -->
            <div class="glass rounded-2xl p-6 shadow-xl">
              <h3 class="text-xl font-bold text-white mb-4">Spielstand</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between text-white">
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 mr-2"></div>
                    <span>Gelb</span>
                  </div>
                  <span id="yellowScore" class="text-2xl font-bold text-yellow-400">0</span>
                </div>
                <div class="flex items-center justify-between text-white">
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gradient-to-br from-red-500 to-red-700 mr-2"></div>
                    <span>Rot</span>
                  </div>
                  <span id="redScore" class="text-2xl font-bold text-red-400">0</span>
                </div>
              </div>
            </div>

            <!-- Game Status -->
            <div class="glass rounded-2xl p-6 shadow-xl">
              <h3 class="text-xl font-bold text-white mb-4">Spiel-Info</h3>
              <div class="space-y-3 text-white">
                <div class="flex justify-between">
                  <span>Status:</span>
                  <span id="gameStatus" class="font-semibold text-green-400">Spiel l√§uft</span>
                </div>
                <div class="flex justify-between">
                  <span>Z√ºge:</span>
                  <span id="moveCounter" class="font-bold">0</span>
                </div>
              </div>
            </div>

            <!-- Game Controls -->
            <div class="glass rounded-2xl p-6 shadow-xl">
              <h3 class="text-xl font-bold text-white mb-4">Steuerung</h3>
              <div class="space-y-3">
                <button id="newGameBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 shadow-lg glass-hover">
                  üÜï Neues Spiel (N)
                </button>
                <button id="undoBtn" class="w-full glass-dark text-white font-semibold py-3 px-4 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all duration-200 disabled:opacity-50" disabled>
                  ‚Ü∂ R√ºckg√§ngig (U)
                </button>
                <button id="resetScoreBtn" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 shadow-lg glass-hover">
                  üîÑ Score zur√ºcksetzen (F3)
                </button>
                <button id="assistanceBtn" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 shadow-lg glass-hover">
                  üéõÔ∏è Spielerhilfen (F2)
                </button>
                <button id="helpBtn" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 shadow-lg glass-hover">
                  ‚ùì Spielanleitung (F1)
                </button>
              </div>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- Modern Player Assistance Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="assistanceModal">
      <div class="glass rounded-3xl p-8 max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl font-bold text-white">üéõÔ∏è Spielerhilfen</h2>
          <button class="glass-hover rounded-xl p-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-200" id="closeAssistanceModal">
            ‚úï
          </button>
        </div>

        <div class="space-y-6">
          <!-- Assistance Settings Grid -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Feature Column Header -->
            <div class="glass-dark rounded-2xl p-4">
              <h3 class="text-xl font-semibold text-white text-center">Spielerhilfe</h3>
            </div>
            
            <!-- Player 1 Column Header -->
            <div class="glass-dark rounded-2xl p-4 bg-gradient-to-br from-yellow-500 to-yellow-600 bg-opacity-20">
              <h3 class="text-xl font-semibold text-white text-center">üü° Spieler 1 (Gelb)</h3>
            </div>
            
            <!-- Player 2 Column Header -->
            <div class="glass-dark rounded-2xl p-4 bg-gradient-to-br from-red-500 to-red-600 bg-opacity-20">
              <h3 class="text-xl font-semibold text-white text-center">üî¥ Spieler 2 (Rot)</h3>
            </div>
          </div>

          <!-- Assistance Features -->
          <div class="space-y-4">
            
            <!-- Undo Feature -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div class="glass-dark rounded-xl p-4">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">üîÑ</span>
                  <div>
                    <div class="text-white font-semibold">Zug r√ºckg√§ngig machen</div>
                    <div class="text-gray-300 text-sm">Spieler kann eigene Z√ºge r√ºckg√§ngig machen</div>
                  </div>
                </div>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player1-undo" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                </label>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player2-undo" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                </label>
              </div>
            </div>
            
            <!-- Threats Feature -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div class="glass-dark rounded-xl p-4">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">‚ö†Ô∏è</span>
                  <div>
                    <div class="text-white font-semibold">Bedrohungen anzeigen</div>
                    <div class="text-gray-300 text-sm">Zeigt gegnerische Gewinnbedrohungen an</div>
                  </div>
                </div>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player1-threats" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                </label>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player2-threats" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                </label>
              </div>
            
            <!-- Winning Moves Feature -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div class="glass-dark rounded-xl p-4">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">üèÜ</span>
                  <div>
                    <div class="text-white font-semibold">Gewinnz√ºge hervorheben</div>
                    <div class="text-gray-300 text-sm">Markiert direkte Gewinnm√∂glichkeiten</div>
                  </div>
                </div>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player1-winning-moves" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                </label>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player2-winning-moves" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                </label>
              </div>
            </div>
            
            <!-- Blocked Columns Feature -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div class="glass-dark rounded-xl p-4">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">üö´</span>
                  <div>
                    <div class="text-white font-semibold">Gesperrte Spalten anzeigen</div>
                    <div class="text-gray-300 text-sm">Zeigt strategisch ung√ºnstige Spalten an</div>
                  </div>
                </div>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player1-blocked-columns" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                </label>
              </div>
              
              <div class="flex justify-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="player2-blocked-columns" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Help Section -->
          <div class="glass-dark rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
              <span class="text-xl mr-3">‚ÑπÔ∏è</span>
              Hinweise zu den Spielerhilfen
            </h3>
            <div class="space-y-2 text-gray-300">
              <p>‚Ä¢ Spielerhilfen k√∂nnen jederzeit aktiviert/deaktiviert werden</p>
              <p>‚Ä¢ Jeder Spieler kann individuelle Hilfen verwenden</p>
              <p>‚Ä¢ Hilfen beeinflussen nur die Anzeige, nicht die Spiellogik</p>
              <p>‚Ä¢ In KI-Modi gelten Hilfen nur f√ºr menschliche Spieler</p>
            </div>
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex justify-end mt-6">
          <button class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 shadow-lg glass-hover" id="closeAssistanceBtn">
            ‚úÖ Einstellungen √ºbernehmen
          </button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay hidden" id="helpModal">
      <div class="modal help-modal">
        <h2>üî¥ 4 Gewinnt - Spielanleitung</h2>

        <div class="help-content">
          <div class="help-section">
            <h3>üéØ Spielziel</h3>
            <p>
              Verbinde vier deiner Spielsteine in einer geraden Linie (horizontal, vertikal oder diagonal) 
              auf dem 7x6 Spielfeld!
            </p>
          </div>

          <div class="help-section">
            <h3>üéÆ Spielablauf</h3>
            <ul>
              <li>Gelb beginnt und wirft den ersten Spielstein ein</li>
              <li>Spieler werfen abwechselnd ihre Steine in eine der 7 Spalten</li>
              <li>Steine fallen durch die Schwerkraft nach unten</li>
              <li>Der erste Spieler mit 4 Steinen in einer Reihe gewinnt</li>
              <li>Bei vollem Brett ohne Gewinner gibt es ein Unentschieden</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üéÆ Steuerung</h3>
            <div class="control-group">
              <h4>üñ±Ô∏è Maus/Touch:</h4>
              <ul>
                <li><strong>Klick:</strong> Stein in Spalte einwerfen</li>
                <li><strong>Hover:</strong> Vorschau des Zuges anzeigen</li>
              </ul>
            </div>

            <div class="control-group">
              <h4>‚å®Ô∏è Tastatur:</h4>
              <ul>
                <li><strong>1-7:</strong> Stein in Spalte 1-7 einwerfen</li>
                <li><strong>N:</strong> Neues Spiel</li>
                <li><strong>U:</strong> Zug r√ºckg√§ngig</li>
                <li><strong>F1:</strong> Spielanleitung √∂ffnen/schlie√üen</li>
                <li><strong>F2:</strong> Spielerhilfen √∂ffnen/schlie√üen</li>
                <li><strong>F3:</strong> Score zur√ºcksetzen</li>
              </ul>
            </div>
          </div>

          <div class="help-section">
            <h3>ü§ñ Spielmodi</h3>
            <ul>
              <li><strong>2 Spieler:</strong> Spiele gegen einen Freund</li>
              <li><strong>vs Einfache KI:</strong> Perfekt f√ºr Anf√§nger</li>
              <li><strong>vs Mittlere KI:</strong> Ausbalancierte Herausforderung</li>
              <li><strong>vs Schwere KI:</strong> Maximale Herausforderung mit Minimax-Algorithmus</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üéõÔ∏è Spielerhilfen</h3>
            <ul>
              <li><strong>Gewinnz√ºge:</strong> Gr√ºn leuchtende Spalten f√ºhren zum sofortigen Sieg</li>
              <li><strong>Bedrohungen:</strong> Orange markierte Spalten blockieren gegnerische Gewinne</li>
              <li><strong>Gesperrte Spalten:</strong> Rot markierte Spalten sollten vermieden werden</li>
              <li><strong>R√ºckg√§ngig:</strong> Erlaubt das Zur√ºcknehmen von Z√ºgen</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üìã Regeln</h3>
            <ul>
              <li>Steine k√∂nnen nur von oben eingeworfen werden</li>
              <li>Jede Spalte kann maximal 6 Steine aufnehmen</li>
              <li>Nur gerade Linien z√§hlen (keine Kurven oder Ecken)</li>
              <li>4 oder mehr Steine in einer Reihe bedeuten Sieg</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>üí° Strategietipps</h3>
            <ul>
              <li>Beginne in der Mitte f√ºr die meisten M√∂glichkeiten</li>
              <li>Versuche gleichzeitig anzugreifen und zu verteidigen</li>
              <li>Erstelle "Gabeln" - mehrere Gewinnchancen gleichzeitig</li>
              <li>Blockiere gegnerische Bedrohungen fr√ºhzeitig</li>
              <li>Plane deine Z√ºge mehrere Runden im Voraus</li>
              <li>Kontrolliere die unteren Reihen f√ºr stabilere Positionen</li>
            </ul>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="btn btn-primary" id="closeHelpBtn">Verstanden!</button>
        </div>
      </div>
    </div>

    <!-- Debug Modal System -->
    <script src="debug-modal.js"></script>
    
    <!-- Quick Fix for Modal and Board Issues -->
    <script src="quick-fix.js"></script>
    
    <script type="module">
      // WASM and UI-Module System Connect4 initialization
      import init, { Connect4Game, Connect4AI, AIDifficulty } from '../../game_engine/pkg/game_engine.js';
      import { Connect4UI } from './js/ui.js?v=production';
      import { Connect4GameBitPacked } from './js/game.js';
      
      // Initialize game when DOM is loaded
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          // Initialize WASM first
          await init();
          console.log('ü¶Ä WASM initialized successfully');
          
          // Check if required DOM elements exist
          const gameBoard = document.getElementById('gameBoard');
          if (!gameBoard) {
            throw new Error('Game board element not found in DOM');
          }
          
          const game = new Connect4GameBitPacked();
          const ui = new Connect4UI(game);
          
          // Initialize AI with proper difficulty based on game mode
          function initializeAI(gameMode) {
            if (!gameMode || !gameMode.includes('vs-bot')) {
              return null;
            }
            
            let difficulty;
            switch (gameMode) {
              case 'vs-bot-easy':
                difficulty = AIDifficulty.Easy;
                break;
              case 'vs-bot-medium':
                difficulty = AIDifficulty.Medium;
                break;
              case 'vs-bot-hard':
                difficulty = AIDifficulty.Hard;
                break;
              default:
                difficulty = AIDifficulty.Medium;
            }
            
            const ai = Connect4AI.with_difficulty(difficulty);
            console.log(`ü§ñ AI initialized with difficulty: ${gameMode} -> ${difficulty}`);
            return ai;
          }
          
          // Set up initial AI based on current game mode
          const initialMode = document.getElementById('gameMode')?.value || 'two-player';
          ui.wasmGame = game;
          
          // Set initial AI difficulty in the game directly
          if (initialMode.includes('vs-bot')) {
            let difficulty;
            switch (initialMode) {
              case 'vs-bot-easy':
                difficulty = AIDifficulty.Easy;
                break;
              case 'vs-bot-medium':
                difficulty = AIDifficulty.Medium;
                break;
              case 'vs-bot-hard':
                difficulty = AIDifficulty.Hard;
                break;
              default:
                difficulty = AIDifficulty.Medium;
            }
            
            game.set_ai_difficulty(difficulty);
            console.log(`ü§ñ Initial AI difficulty set: ${initialMode} -> ${difficulty}`);
          }
          
          // REMOVED: ui.setAI(ai); - UI uses WASM AI directly from game.getAIMove()
          
          // Make instances globally available for debugging
          window.game = game;
          window.ui = ui;
          window.AIDifficulty = AIDifficulty; // For debugging
          
          // Debug helper for AI testing
          window.testAI = (difficulty) => {
            game.set_ai_difficulty(difficulty);
            console.log(`üîß Debug: AI difficulty set to ${difficulty}`);
            console.log(`üîß Current difficulty: ${game.get_ai_difficulty()}`);
          };
          
          // Setup game mode handling with AI re-initialization
          const gameModeSelect = document.getElementById('gameMode');
          if (gameModeSelect) {
            gameModeSelect.addEventListener('change', () => {
              const newMode = gameModeSelect.value;
              
              // Set AI difficulty directly in the game
              if (newMode.includes('vs-bot')) {
                let difficulty;
                switch (newMode) {
                  case 'vs-bot-easy':
                    difficulty = AIDifficulty.Easy;
                    break;
                  case 'vs-bot-medium':
                    difficulty = AIDifficulty.Medium;
                    break;
                  case 'vs-bot-hard':
                    difficulty = AIDifficulty.Hard;
                    break;
                  default:
                    difficulty = AIDifficulty.Medium;
                }
                
                game.set_ai_difficulty(difficulty);
                console.log(`ü§ñ AI difficulty set to: ${newMode} -> ${difficulty}`);
              }
              
              // Update UI configuration
              ui.setGameMode(newMode);
              
              console.log(`üîÑ Game mode changed to: ${newMode}`);
            });
          }
          
          // Initialize UI first
          await ui.init();
          
          // ROBUST TIMING: Multiple initialization attempts with exponential backoff
          let gameInitialized = false;
          let initAttempts = 0;
          const maxAttempts = 5;
          
          while (!gameInitialized && initAttempts < maxAttempts) {
            initAttempts++;
            
            try {
              gameInitialized = await game.init();
              
              if (gameInitialized) {
                // Verify game is truly ready with timeout
                const verificationStart = Date.now();
                const maxVerificationTime = 3000;
                
                while (!ui.isInitialized && (Date.now() - verificationStart) < maxVerificationTime) {
                  await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (ui.isInitialized) {
                  ui.showMessage('Connect4 bereit! üéØ', 'success');
                  break;
                } else {
                  gameInitialized = false;
                }
              }
              
            } catch (initError) {
              // Silent failure, will retry
            }
            
            if (!gameInitialized && initAttempts < maxAttempts) {
              const backoffDelay = Math.min(1000 * Math.pow(2, initAttempts - 1), 5000);
              await new Promise(resolve => setTimeout(resolve, backoffDelay));
            }
          }
          
          if (!gameInitialized) {
            ui.showMessage('WASM Engine konnte nicht geladen werden. Browser-Reload versuchen.', 'error');
          }
          
        } catch (error) {
          console.error('‚ùå Failed to initialize Connect4 game:', error);
          
          // Show user-friendly error
          const errorDiv = document.createElement('div');
          errorDiv.innerHTML = `
            <div style="position: fixed; top: 20px; left: 20px; right: 20px; background: #f44336; color: white; padding: 15px; border-radius: 8px; z-index: 1000; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
              <h3 style="margin: 0 0 10px 0;">‚ùå Spielfehler</h3>
              <p style="margin: 0 0 10px 0;"><strong>Fehler:</strong> ${error.message}</p>
              <p style="margin: 0; font-size: 12px; opacity: 0.9;">Bitte laden Sie die Seite neu (F5).</p>
            </div>
          `;
          document.body.appendChild(errorDiv);
        }
        
        // SIMPLE MODAL SYSTEM: Direct implementation instead of complex import
        console.log('üîÑ Setting up DIRECT modal system...');
        setupDirectModalSystem();
        
        // DIRECT MODAL SYSTEM: Robust implementation
        function setupDirectModalSystem() {
          console.log('üéØ Setting up Direct Modal System...');
          
          const showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
              // Force visibility with inline styles
              modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(0, 0, 0, 0.8) !important;
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
              `;
              
              // Style modal content
              const modalContent = modal.querySelector('.modal');
              if (modalContent) {
                modalContent.style.cssText = `
                  background: white !important;
                  padding: 2rem !important;
                  border-radius: 12px !important;
                  max-width: 600px !important;
                  max-height: 80vh !important;
                  overflow-y: auto !important;
                  color: black !important;
                  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
                `;
              }
              
              modal.classList.remove('hidden');
              document.body.style.overflow = 'hidden'; // Lock body scroll
              console.log(`‚úÖ Direct: Showing ${modalId}`);
            }
          };
          
          const hideModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
              modal.style.display = 'none';
              modal.classList.add('hidden');
              document.body.style.overflow = ''; // Unlock body scroll
              console.log(`‚úÖ Direct: Hiding ${modalId}`);
            }
          };
          
          // Setup all event handlers
          document.getElementById('helpBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            showModal('helpModal');
          });
          
          document.getElementById('assistanceBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            showModal('assistanceModal');
          });
          
          document.getElementById('closeHelpBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal('helpModal');
          });
          
          document.getElementById('closeAssistanceBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            hideModal('assistanceModal');
          });
          
          // Click outside to close
          document.getElementById('helpModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') hideModal('helpModal');
          });
          
          document.getElementById('assistanceModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'assistanceModal') hideModal('assistanceModal');
          });
          
          // Keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') {
              e.preventDefault();
              const helpModal = document.getElementById('helpModal');
              if (helpModal && helpModal.style.display === 'none') {
                showModal('helpModal');
              } else {
                hideModal('helpModal');
              }
            } else if (e.key === 'F2') {
              e.preventDefault();
              const assistanceModal = document.getElementById('assistanceModal');
              if (assistanceModal && assistanceModal.style.display === 'none') {
                showModal('assistanceModal');
              } else {
                hideModal('assistanceModal');
              }
            } else if (e.key === 'Escape') {
              hideModal('helpModal');
              hideModal('assistanceModal');
            }
          });
          
          console.log('‚úÖ Direct Modal System initialized with F1/F2/Escape support');
          
          // Make showModal available globally for testing
          window.showModal = showModal;
          window.hideModal = hideModal;
        }
        
        // DIRECT BOARD RENDERING: Fallback if UI system fails
        setTimeout(() => {
          const gameBoard = document.getElementById('gameBoard');
          if (gameBoard && gameBoard.children.length === 0) {
            console.log('üîß UI system failed - setting up direct board rendering...');
            setupDirectBoardRendering();
          }
        }, 2000);
        
        function setupDirectBoardRendering() {
          const gameBoard = document.getElementById('gameBoard');
          if (!gameBoard) return;
          
          console.log('üéØ Setting up Direct Board Rendering...');
          
          // Apply board styles
          gameBoard.style.cssText = `
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            grid-template-rows: repeat(6, 1fr) !important;
            gap: 8px !important;
            background: #1976d2 !important;
            border-radius: 16px !important;
            padding: 20px !important;
            width: 100% !important;
            aspect-ratio: 7/6 !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.2) !important;
            max-width: min(80vw, calc(70vh * 7 / 6)) !important;
            max-height: min(70vh, calc(80vw * 6 / 7)) !important;
          `;
          
          // Clear and create 42 cells (6x7)
          gameBoard.innerHTML = '';
          for (let row = 0; row < 6; row++) {
            for (let col = 0; col < 7; col++) {
              const cell = document.createElement('div');
              cell.className = 'cell game-slot';
              cell.dataset.row = row;
              cell.dataset.col = col;
              cell.dataset.index = row * 7 + col;
              
              cell.style.cssText = `
                background: #2196F3 !important;
                border-radius: 50% !important;
                border: 3px solid #1976D2 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                position: relative !important;
                cursor: pointer !important;
                aspect-ratio: 1 !important;
              `;
              
              // Add disc placeholder
              const disc = document.createElement('div');
              disc.className = 'disc empty';
              disc.style.cssText = `
                width: 85% !important;
                height: 85% !important;
                border-radius: 50% !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                aspect-ratio: 1 !important;
                z-index: 1 !important;
                background: transparent !important;
              `;
              
              cell.appendChild(disc);
              gameBoard.appendChild(cell);
              
              // Add click handler for column drop
              cell.addEventListener('click', () => {
                console.log(`üéØ Cell clicked: row ${row}, col ${col}`);
                if (window.ui && typeof window.ui.dropDiscInColumn === 'function') {
                  window.ui.dropDiscInColumn(col);
                } else if (window.game && typeof window.game.makeMove === 'function') {
                  window.game.makeMove(col);
                  updateCellVisual(row, col, 1); // Yellow for demo
                }
              });
            }
          }
          
          console.log('‚úÖ Direct Board Rendering complete - 42 cells created');
          
          // Demo function to update cell visuals
          function updateCellVisual(row, col, player) {
            const cell = gameBoard.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cell) {
              const disc = cell.querySelector('.disc');
              if (disc) {
                disc.classList.remove('empty');
                disc.classList.add(player === 1 ? 'yellow' : 'red');
                
                if (player === 1) {
                  disc.style.cssText += `
                    background: #FFD700 !important;
                    border: 3px solid #FFA000 !important;
                    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.6) !important;
                  `;
                } else {
                  disc.style.cssText += `
                    background: #F44336 !important;
                    border: 3px solid #D32F2F !important;
                    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.6) !important;
                  `;
                }
              }
            }
          }
          
          window.updateCellVisual = updateCellVisual;
        }
        
      });
    </script>
  </body>
</html>