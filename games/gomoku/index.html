<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5 Gewinnt (Gomoku) - LogicCastle</title>
    <link rel="stylesheet" href="css/game.css?v=20250701_vmin_square_fix" />
    <link rel="stylesheet" href="css/ui.css?v=20250701_no_transform" />
    <link rel="stylesheet" href="css/wasm-enhancements.css?v=20250701_final_animation_fix" />
    <link rel="stylesheet" href="css/assistance.css?v=20250702_assistance_system" />
  </head>
  <body>
    <div class="minimal-game-container">
      <div class="game-board-container">
        <!-- Add required UI elements for UI-Module System -->
        <div id="gameStatus" style="display: none;">Ready</div>
        <div id="currentPlayerIndicator" style="display: none;">
          <span class="player-indicator">
            <span class="player-stone black"></span>
            Black to move
          </span>
        </div>
        
        <div class="game-board" id="gameBoard">
          <!-- 15x15 grid = 225 intersections -->
          <!-- Generated dynamically by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Load WASM and initialize game modules -->
    <script type="module">
      import init, { Game, Player, GomokuBoard } from '../../game_engine/pkg/game_engine.js';
      import { GomokuGame } from './js/game_v2.js';
      import { GomokuUINew } from './js/ui-new.js';
      import { EnhancedGobangAI } from './js/ai-enhanced.js';
      import { GomokuAssistanceSystem } from './js/assistance-system.js';
      import { WasmGomokuIntegration } from './js/wasm-integration.js';
      import { BitPackedGomokuIntegration } from './js/bitpacked-integration.js';

      // Progressive WASM loading strategy for GitHub Pages compatibility
      async function initWasmWithFallback() {
        // Detect environment for optimal loading strategy
        const isGitHubPages = window.location.hostname.includes('github.io') || 
                             window.location.hostname.includes('pages.dev');
        
        console.log(`üåê Environment detected: ${isGitHubPages ? 'GitHub Pages' : 'Local Development'}`);
        
        try {
          if (isGitHubPages) {
            // GitHub Pages strategy: Use fetch + instantiate (bypasses MIME type issues)
            console.log('üîß Using GitHub Pages compatible WASM loading...');
            await init();
          } else {
            // Local development: Use standard streaming (optimal performance)
            console.log('üöÄ Using streaming WASM loading for local development...');
            await init();
          }
          
          console.log('‚úÖ WASM module initialized successfully');
          return true;
        } catch (error) {
          console.error('‚ùå WASM initialization failed:', error);
          throw error;
        }
      }

      async function initializeGomoku() {
        try {
          // Initialize WASM module with fallback strategy
          await initWasmWithFallback();
          
          // Make WASM classes available globally for compatibility
          window.WasmGame = Game;
          window.WasmPlayer = Player;
          
          // Initialize game - handle both pre-loaded and post-loaded DOM states
          async function initializeGameUI() {
            console.log('üéÆ Starting minimal game UI initialization...');
            
            try {
              console.log('üéØ Creating GomokuGame...');
              const game = new GomokuGame();
              
              console.log('ü¶Ä Initializing game WASM...');
              await game.init(); // Initialize WASM
              
              console.log('üé® Creating GomokuUINew...');
              const ui = new GomokuUINew(game);
              
              console.log('üîß Initializing UI...');
              await ui.init();
              
              // Make objects globally available for debugging and integration
              console.log('üåê Making objects globally available...');
              window.game = game;
              window.ui = ui;
              
              console.log('‚úÖ Game and UI initialization complete!');
              
              // Crosshair system testing functions
              window.testCrosshair = () => ui.testCrosshairPositions();
              window.validateLines = () => ui.validateLineAlignment();
              
              // Initialize WASM integration for move analysis dashboard
              try {
                console.log('üîß Initializing WASM Integration...');
                const wasmIntegration = new WasmGomokuIntegration(ui);
                ui.wasmIntegration = wasmIntegration;
                
                // CRITICAL: Initialize the WASM engine
                await wasmIntegration.initializeWasmEngine();
                
                console.log('‚úÖ WASM Integration enabled');
                
                // Initialize BitPackedBoard integration for performance optimization
                console.log('‚ö° Initializing BitPackedBoard Integration...');
                const bitPackedIntegration = new BitPackedGomokuIntegration(ui);
                ui.bitPackedIntegration = bitPackedIntegration;
                
                console.log('‚ö° BitPackedBoard Integration enabled');
              } catch (integrationError) {
                console.warn('‚ö†Ô∏è WASM Integration disabled due to conflicts:', integrationError.message);
              }
              
            } catch (error) {
              console.error('‚ùå Game/UI initialization failed:', error);
              console.error('Error stack:', error.stack);
              throw error;
            }
            
            console.log('üéÆ Minimal Gomoku initialized with ES6 modules + WASM integration');
          }
          
          // Call initialization immediately if DOM is ready, or wait for it
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGameUI);
          } else {
            // DOM is already ready, initialize immediately
            await initializeGameUI();
          }
          
        } catch (error) {
          console.error('‚ùå Failed to initialize Gomoku WASM:', error);
          
          // Graceful degradation: Keep UI structure, show WASM status
          document.addEventListener('DOMContentLoaded', () => {
            console.log('üõ°Ô∏è Graceful degradation activated - minimal UI preserved');
          });
        }
      }
      
      initializeGomoku().catch(console.error);
    </script>
  </body>
</html>