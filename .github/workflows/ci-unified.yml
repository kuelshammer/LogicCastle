name: LogicCastle CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  CI: true

jobs:
  # Fast quality checks - fail fast
  quality:
    name: ğŸ“‹ Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        
    - name: ğŸ” ESLint check
      run: npm run lint:check
      
    - name: ğŸ’… Prettier format check  
      run: npm run format:check

  # Unit tests - fast feedback
  test-unit:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        
    - name: ğŸ§ª Run Vitest unit tests
      run: npm run test:ci-fast
      env:
        CI_TIMEOUT_MULTIPLIER: 2
        
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-node-${{ matrix.node-version }}
        path: |
          test-results-vitest.json
          test-results-vitest.xml
        retention-days: 3

  # Integration tests with Puppeteer
  test-integration:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        # Install Chrome dependencies for Puppeteer
        sudo apt-get update
        sudo apt-get install -y chromium-browser
        
    - name: ğŸŒ Start HTTP server
      run: |
        npm run serve &
        sleep 5
        curl -f http://localhost:8080 || (echo "Server failed to start" && exit 1)
        
    - name: ğŸ”— Run integration tests
      run: npm run test:ci-slow
      env:
        CI_TIMEOUT_MULTIPLIER: 3
        PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
        
    - name: ğŸ“Š Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          test-results.json
          test-results.xml
        retention-days: 3

  # Browser compatibility tests
  test-browser:
    name: ğŸŒ Browser Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test-unit]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        sudo apt-get update
        sudo apt-get install -y chromium-browser firefox
        
    - name: ğŸŒ Start HTTP server
      run: |
        npm run serve &
        sleep 5
        
    - name: ğŸ§ª Test basic functionality
      run: |
        node -e "
        const puppeteer = require('puppeteer');
        
        (async () => {
          const browser = await puppeteer.launch({
            executablePath: '/usr/bin/chromium-browser',
            headless: true,
            args: ['--no-sandbox', '--disable-dev-shm-usage']
          });
          
          const page = await browser.newPage();
          
          // Test main page
          await page.goto('http://localhost:8080/index.html');
          const title = await page.title();
          console.log('âœ… Main page loads:', title);
          
          // Test Connect4 page
          await page.goto('http://localhost:8080/games/connect4/index.html');
          const connect4Title = await page.title();
          console.log('âœ… Connect4 page loads:', connect4Title);
          
          // Check critical elements exist
          const gameBoard = await page.$('#gameBoard');
          const newGameBtn = await page.$('#newGameBtn');
          
          if (!gameBoard) throw new Error('âŒ Game board not found');
          if (!newGameBtn) throw new Error('âŒ New game button not found');
          
          console.log('âœ… All critical elements present');
          
          await browser.close();
        })();
        "

  # Performance tests
  test-performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test-unit]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        npm install -g lighthouse
        
    - name: ğŸŒ Start HTTP server
      run: |
        npm run serve &
        sleep 5
        
    - name: âš¡ Run Lighthouse performance tests
      run: |
        lighthouse http://localhost:8080/index.html \
          --output json \
          --output-path ./lighthouse-main.json \
          --quiet \
          --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" || echo "Lighthouse completed with warnings"
          
        # Extract and display key metrics
        if [ -f lighthouse-main.json ]; then
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./lighthouse-main.json'));
            const metrics = report.lhr.audits;
            const score = Math.round(report.lhr.categories.performance.score * 100);
            console.log('ğŸ“Š Performance Score:', score);
            console.log('ğŸ¨ First Contentful Paint:', metrics['first-contentful-paint'].displayValue);
            console.log('ğŸ–¼ï¸ Largest Contentful Paint:', metrics['largest-contentful-paint'].displayValue);
            
            if (score < 70) {
              console.log('âš ï¸ Performance score below threshold (70)');
              process.exit(1);
            }
          "
        fi

  # Security checks
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: ğŸ” Run security audit
      run: |
        npm audit --audit-level moderate || {
          echo "âš ï¸ Security vulnerabilities found. Review and fix before merging."
          npm audit --audit-level moderate --json > audit-results.json
          exit 1
        }

  # Deployment (only on main branch success)
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality, test-unit, test-integration, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        
    - name: ğŸ“ Create deployment summary
      run: |
        echo "## ğŸ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code quality checks passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All unit tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Integration tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Live Site:" >> $GITHUB_STEP_SUMMARY
        echo "[https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY

  # Publish test results
  publish-results:
    name: ğŸ“Š Publish Test Results
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    if: always()
    
    steps:
    - name: ğŸ“¥ Download test artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '*-test-results*'
        merge-multiple: true
        
    - name: ğŸ“Š Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: LogicCastle Test Results
        path: 'test-results*.xml'
        reporter: java-junit
        fail-on-error: false